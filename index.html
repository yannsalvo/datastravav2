<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strava Monthly Recap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .strava-connect-btn {
            background: #fc4c02;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(252, 76, 2, 0.3);
        }

        .strava-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(252, 76, 2, 0.4);
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .controls h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group select option {
            background: #1a1a1a;
            color: white;
        }

        .generate-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .recap-canvas {
            display: none;
            margin: 40px auto;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: #ff6b35;
        }

        .error {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #ff6b35;
            text-align: center;
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
        }

        .download-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .auth-section,
            .controls {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Strava Monthly Recap</h1>
            <p>Cr√©ez vos r√©capitulatifs mensuels styl√©s pour Instagram</p>
        </div>

        <div class="auth-section" id="authSection">
            <h3>Connectez-vous √† Strava</h3>
            <p style="margin-bottom: 20px;">Cliquez sur le bouton ci-dessous pour vous connecter directement avec votre compte Strava et autoriser l'acc√®s √† vos donn√©es d'activit√©.</p>
            <p style="margin-bottom: 25px; font-size: 0.9rem; color: #888; line-height: 1.5;">
                <strong>‚úÖ Application configur√©e :</strong> La connexion Strava est pr√™te √† l'emploi ! 
                Vous serez redirig√© vers Strava pour autoriser l'acc√®s, puis de retour ici automatiquement.
            </p>
            <button class="strava-connect-btn" onclick="connectStrava()">
                üö¥ Se connecter avec Strava
            </button>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <h3>Param√®tres du r√©capitulatif</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label for="monthSelect">Mois :</label>
                    <select id="monthSelect">
                        <option value="1">Janvier</option>
                        <option value="2">F√©vrier</option>
                        <option value="3">Mars</option>
                        <option value="4">Avril</option>
                        <option value="5">Mai</option>
                        <option value="6">Juin</option>
                        <option value="7" selected>Juillet</option>
                        <option value="8">Ao√ªt</option>
                        <option value="9">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="yearSelect">Ann√©e :</label>
                    <select id="yearSelect">
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="maxActivities">Nombre maximum d'activit√©s √† afficher :</label>
                <input type="range" id="maxActivities" min="3" max="30" value="16" 
                       style="width: 100%; margin-bottom: 10px;" 
                       oninput="updateActivityCount(this.value)">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem; color: #888;">3 activit√©s</span>
                    <span id="activityCount" style="font-weight: 600; color: #ff6b35;">16 activit√©s</span>
                    <span style="font-size: 0.9rem; color: #888;">30 activit√©s</span>
                </div>
            </div>

            <button class="generate-btn" onclick="generateRecap()" id="generateBtn">
                G√©n√©rer le r√©capitulatif
            </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>G√©n√©ration du r√©capitulatif en cours...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <canvas id="recapCanvas" class="recap-canvas" width="1080" height="1920"></canvas>

        <div class="download-section" id="downloadSection" style="display: none;">
            <button class="download-btn" onclick="downloadImage('png')">T√©l√©charger PNG</button>
            <button class="download-btn" onclick="downloadImage('jpg')">T√©l√©charger JPG</button>
        </div>
    </div>

    <script>
        // Configuration Strava API
        const STRAVA_CLIENT_ID = '150117';
        const STRAVA_CLIENT_SECRET = '77c21110432ac6a7b3ad9f963fe3be355b9e08f5';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        let accessToken = null;
        let activities = [];

        // V√©rifier si on revient d'une auth Strava
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                exchangeToken(code);
            }
        });

        function updateActivityCount(value) {
            document.getElementById('activityCount').textContent = `${value} activit√©s`;
        }

        function calculateGridDimensions(activityCount) {
            // Calculer les dimensions optimales pour la grille
            if (activityCount <= 4) return { cols: 2, rows: 2 };
            if (activityCount <= 6) return { cols: 3, rows: 2 };
            if (activityCount <= 9) return { cols: 3, rows: 3 };
            if (activityCount <= 12) return { cols: 4, rows: 3 };
            if (activityCount <= 16) return { cols: 4, rows: 4 };
            if (activityCount <= 20) return { cols: 5, rows: 4 };
            if (activityCount <= 25) return { cols: 5, rows: 5 };
            return { cols: 6, rows: 5 }; // Pour 26-30 activit√©s
        }

        function connectStrava() {
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&approval_prompt=force&scope=read,activity:read`;
            window.location.href = authUrl;
        }

        async function exchangeToken(code) {
            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: STRAVA_CLIENT_ID,
                        client_secret: STRAVA_CLIENT_SECRET,
                        code: code,
                        grant_type: 'authorization_code'
                    })
                });

                const data = await response.json();
                
                if (data.access_token) {
                    accessToken = data.access_token;
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('controls').style.display = 'block';
                    
                    // Nettoyer l'URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    showError('Erreur lors de l\'authentification Strava');
                }
            } catch (error) {
                showError('Erreur lors de l\'authentification: ' + error.message);
            }
        }

        async function generateRecap() {
            if (!accessToken) {
                showError('Veuillez vous connecter √† Strava d\'abord');
                return;
            }

            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('error').style.display = 'none';

            try {
                await fetchActivities(month, year);
                drawRecap(month, year);
            } catch (error) {
                showError('Erreur lors de la g√©n√©ration: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
            }
        }

        async function fetchActivities(month, year) {
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 0, 23, 59, 59);
            
            const after = Math.floor(startOfMonth.getTime() / 1000);
            const before = Math.floor(endOfMonth.getTime() / 1000);

            const response = await fetch(
                `https://www.strava.com/api/v3/athlete/activities?after=${after}&before=${before}&per_page=200`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Erreur lors de la r√©cup√©ration des activit√©s');
            }

            activities = await response.json();
        }

        function drawRecap(month, year) {
            const canvas = document.getElementById('recapCanvas');
            const ctx = canvas.getContext('2d');

            // Obtenir le nombre max d'activit√©s s√©lectionn√©
            const maxActivities = parseInt(document.getElementById('maxActivities').value);
            const activitiesToShow = activities.slice(0, maxActivities);
            const { cols, rows } = calculateGridDimensions(activitiesToShow.length);

            // Fond noir
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Titre principal
            ctx.fillStyle = '#ffffff';
            ctx.font = '300 48px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('R√©cap du mois', canvas.width / 2, 150);

            // Mois
            const monthNames = ['', 'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                             'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            ctx.font = 'italic 700 72px Inter';
            ctx.fillText(monthNames[month], canvas.width / 2, 230);

            // Zone pour les trac√©s - grille adaptative
            const gridStartY = 320;
            const maxGridWidth = 900;
            const maxGridHeight = 900;
            
            // Calculer la taille des cellules en fonction du nombre de colonnes/lignes
            const cellSize = Math.min(maxGridWidth / cols, maxGridHeight / rows, 180);
            const gridWidth = cols * cellSize;
            const gridHeight = rows * cellSize;
            const gridStartX = (canvas.width - gridWidth) / 2;

            // Dessiner les trac√©s des activit√©s
            activitiesToShow.forEach((activity, index) => {
                const row = Math.floor(index / cols);
                const col = index % cols;
                const x = gridStartX + col * cellSize;
                const y = gridStartY + row * cellSize;
                
                drawActivityTrace(ctx, activity, x, y, cellSize);
            });

            // Statistiques - ajuster la position selon la hauteur de la grille
            const totalDistance = activities.reduce((sum, act) => sum + (act.distance || 0), 0);
            const totalTime = activities.reduce((sum, act) => sum + (act.moving_time || 0), 0);
            const totalElevation = activities.reduce((sum, act) => sum + (act.total_elevation_gain || 0), 0);

            const statsY = gridStartY + gridHeight + 80;
            
            ctx.font = '600 42px Inter';
            ctx.textAlign = 'left';
            
            // Activit√©s (afficher le nombre total, pas seulement celles affich√©es)
            ctx.fillText(`${activities.length} activit√©s`, 140, statsY);
            
            // Distance
            ctx.fillText(`${(totalDistance / 1000).toFixed(1)}km`, 540, statsY);
            
            // Temps
            const hours = Math.floor(totalTime / 3600);
            ctx.fillText(`${hours}h`, 140, statsY + 80);
            
            // D√©nivel√©
            ctx.fillText(`${Math.round(totalElevation)}m d√©nivel√©`, 540, statsY + 80);

            // Note si on affiche moins d'activit√©s que le total
            if (activitiesToShow.length < activities.length) {
                ctx.font = '400 28px Inter';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#888888';
                ctx.fillText(`${activitiesToShow.length} premi√®res activit√©s affich√©es`, canvas.width / 2, statsY + 140);
                ctx.fillStyle = '#ffffff';
            }

            // Logo/mention Strava
            ctx.font = '400 32px Inter';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#888888';
            ctx.fillText('@strava', canvas.width / 2, canvas.height - 80);

            // Afficher le canvas
            canvas.style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        }

        function drawActivityTrace(ctx, activity, x, y, size) {
            if (!activity.map || !activity.map.summary_polyline) {
                // Dessiner un trac√© g√©n√©rique si pas de donn√©es GPS
                drawGenericTrace(ctx, x, y, size);
                return;
            }

            // D√©coder le polyline
            const points = decodePolyline(activity.map.summary_polyline);
            if (points.length < 2) {
                drawGenericTrace(ctx, x, y, size);
                return;
            }

            // Trouver les bounds
            let minLat = points[0][0], maxLat = points[0][0];
            let minLng = points[0][1], maxLng = points[0][1];
            
            points.forEach(point => {
                minLat = Math.min(minLat, point[0]);
                maxLat = Math.max(maxLat, point[0]);
                minLng = Math.min(minLng, point[1]);
                maxLng = Math.max(maxLng, point[1]);
            });

            // Padding pour le trac√©
            const padding = size * 0.1;
            const drawWidth = size - 2 * padding;
            const drawHeight = size - 2 * padding;

            ctx.strokeStyle = '#ff6b35';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();

            points.forEach((point, index) => {
                const px = x + padding + ((point[1] - minLng) / (maxLng - minLng)) * drawWidth;
                const py = y + padding + ((maxLat - point[0]) / (maxLat - minLat)) * drawHeight;
                
                if (index === 0) {
                    ctx.moveTo(px, py);
                } else {
                    ctx.lineTo(px, py);
                }
            });

            ctx.stroke();
        }

        function drawGenericTrace(ctx, x, y, size) {
            const padding = size * 0.2;
            const points = [];
            
            // G√©n√©rer quelques points al√©atoires pour simuler un trac√©
            for (let i = 0; i < 8; i++) {
                points.push([
                    x + padding + Math.random() * (size - 2 * padding),
                    y + padding + Math.random() * (size - 2 * padding)
                ]);
            }

            ctx.strokeStyle = '#ff6b35';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();

            points.forEach((point, index) => {
                if (index === 0) {
                    ctx.moveTo(point[0], point[1]);
                } else {
                    ctx.lineTo(point[0], point[1]);
                }
            });

            ctx.stroke();
        }

        // Fonction pour d√©coder le polyline de Google
        function decodePolyline(str) {
            let index = 0, lat = 0, lng = 0;
            const coordinates = [];
            let shift = 0, result = 0, byte = null;

            while (index < str.length) {
                byte = null;
                shift = 0;
                result = 0;

                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                const deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += deltaLat;

                shift = 0;
                result = 0;

                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                const deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += deltaLng;

                coordinates.push([lat / 1e5, lng / 1e5]);
            }

            return coordinates;
        }

        function downloadImage(format) {
            const canvas = document.getElementById('recapCanvas');
            const link = document.createElement('a');
            
            if (format === 'png') {
                link.download = 'strava-recap.png';
                link.href = canvas.toDataURL();
            } else {
                link.download = 'strava-recap.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
            }
            
            link.click();
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>